---
tags:
  - 多线程
  - 进程安全
  - 进程间通信
---
# 多线程编程

多线程编程一般使用的是基于POSIX标准的系统接口pthread实现的。不同的操作系统可能有不同的接口，但是POSIX（Portable Operating System Interface, 可移植操作系统接口）是一个统一的标准和要求。在所有符合POSIX标准的系统上，（无论是linux、windows-WSL还是其他类unix系统）都可以使用。

多线程编程的核心难点在于**线程安全性**和**进程间通信**。

线程安全需要程序员对于共享资源的访问和线程的时序加以更多的考虑，以避免内存泄露和分布式系统的一致性等问题。

进程之下的线程资源是共享的，但是多个进程之间的资源是不共享的，需要使用合适的方法在不同的进程之间进行通信，

**pthread_create**

最常用的函数是pthread_create，这个函数会根据attr这一属性，向start_routine这一函数入口传递arg结构体作为参数，运行一个新的线程。这个线程的接口是pthread_t结构体。

```c
int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine)(void*), void *arg);
```

1. `thread`：这是一个输出参数，用于接收新创建线程的标识符。
2. `attr`：用于指定新线程的属性，如线程的堆栈大小、调度策略等。如果设置为 `NULL`，则使用默认属性。
3. `start_routine`：这是一个函数指针，指向新线程将执行的函数。这个函数必须有一个 `void*` 类型的参数，并返回一个 `void*` 类型的值。
4. `arg`：是传递给新线程执行函数的参数，是一个指向存放有函数所需参数的结构体的指针。如果不需要传递参数，可以设置为 `NULL`。
> 如果需要使用pthread_create创建多个进程，应该使用不同的结构体变量arg，使用同一个变量会因为进程间存在的不同步往往无法达到想要的执行效果。

## 1. 线程安全

线程安全主要需要考虑的是对线程间共享资源（临界区资源）的管理和调度，以及线程资源的回收防止内存泄漏的问题。

### 1.1 共享资源管理

对共享资源的管理最主要的方法就是互斥锁。

## 1.2 资源回收

资源回收主要包括：

1. 回收自由分配的结构体数据（malloc、alloc等等），通过自由分配的数据空间不会在函数结束时自动释放需要手动free防止资源泄露。

2. 回收套接字资源。

3. 回收线程防止僵尸线程的出现（自然return、主线程设置信号、pthread_cancel + pthread_join、pthread_detach）。

## 2. 进程间通信：

信号量、共享内存、管道、AF_UNIX族套接字
